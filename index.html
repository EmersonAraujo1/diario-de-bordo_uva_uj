<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Diário de Bordo - Corporativo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
    }

    header {
      display: flex;
      justify-content: space-between;
      padding: 1rem;
      background-color: #002B5B;
      color: white;
      font-weight: 600;
    }

    nav {
      display: flex;
      justify-content: center;
      gap: 1rem;
      background-color: #f1f1f1;
      padding: 0.75rem;
    }

    nav button {
      padding: 0.5rem 1rem;
      font-weight: bold;
      cursor: pointer;
      border: none;
      background-color: #007BFF;
      color: white;
      border-radius: 5px;
    }

    nav button:hover {
      background-color: #0056b3;
    }

    #formView, #adminView, #senhaAdmin {
      display: none;
      flex-direction: column;
      max-width: 800px;
      margin: 2rem auto;
      padding: 2rem;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    label {
      margin-top: 1rem;
      font-weight: 600;
    }

    input, select, textarea {
      width: 100%;
      padding: 0.6rem;
      margin-top: 0.4rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }

    button {
      margin-top: 1.5rem;
      padding: 0.6rem 1rem;
      background-color: #28a745;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #218838;
    }

    #notificacao {
      margin-top: 1rem;
      font-weight: bold;
      color: green;
      min-height: 1.5em;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    th, td {
      padding: 0.6rem;
      text-align: left;
      border-bottom: 1px solid #ddd;
      word-break: break-word;
    }

    th {
      background-color: #f0f0f0;
    }

    tr.pendente {
      background-color: #fff3cd;
    }

    tr.tratativa {
      background-color: #cce5ff;
    }

    tr.resolvido {
      background-color: #d4edda;
    }

    .btn-table {
      background-color: #6c757d;
      padding: 0.3rem 0.6rem;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
    }

    .btn-table:hover {
      background-color: #5a6268;
    }

    .charts {
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
      margin-bottom: 2rem;
    }

    .chart-container {
      flex: 1;
      min-width: 300px;
    }

    /* Flex container for filters */
    #adminView > div.filters {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    #adminView > div.filters > div {
      flex: 1 1 150px;
      min-width: 150px;
    }

  </style>
</head>
<body>
  <header>
    <div>Universidade Veiga de Almeida</div>
    <div>Unijorge</div>
  </header>

  <nav>
    <button onclick="toggleView('formView')">📋 Diário de Bordo</button>
    <button onclick="toggleView('senhaAdmin')">🔒 Admin</button>
  </nav>

  <!-- FORMULÁRIO -->
  <div id="formView" style="display:flex; flex-direction: column;">
    <h2>Registro - Diário de Bordo</h2>
    <label for="nome">Nome:</label>
    <input type="text" id="nome" required />

    <label for="cargo">Cargo:</label>
    <select id="cargo">
      <option>Consultor</option>
      <option>Assistente</option>
      <option>Analista</option>
      <option>Coordenador</option>
      <option>Gerência</option>
    </select>

    <label for="plataforma">Plataforma:</label>
    <select id="plataforma">
      <option>Botmaker</option>
      <option>Olos</option>
      <option>Eaglle</option>
      <option>Lyceum</option>
      <option>Internet</option>
    </select>

    <label for="motivo">Motivo do chamado:</label>
    <select id="motivo">
      <option>Queda</option>
      <option>Instabilidade</option>
      <option>Não consigo acessar</option>
      <option>Sem internet</option>
      <option>Não consigo conectar</option>
      <option>Outro</option>
    </select>

    <label for="obs">Observações:</label>
    <textarea id="obs" rows="3"></textarea>

    <button onclick="enviarFormulario()">🚀 Enviar</button>
    <div id="notificacao"></div>
  </div>

  <!-- SENHA ADMIN -->
  <div id="senhaAdmin" style="display:none; flex-direction: column;">
    <h2>🔐 Acesso Restrito</h2>
    <label for="senha">Senha de administrador:</label>
    <input type="password" id="senha" placeholder="Senha" />
    <button onclick="validarSenha()">Entrar</button>
  </div>

  <!-- PAINEL ADMIN -->
  <div id="adminView" style="display:none; flex-direction: column;">
    <h2>📊 Painel Administrativo</h2>

    <div class="charts">
      <div class="chart-container">
        <canvas id="chartStatus"></canvas>
      </div>
      <div class="chart-container">
        <canvas id="chartPlataforma"></canvas>
      </div>
    </div>

    <div class="filters">
      <div>
        <label for="filtroStatus">Status:</label>
        <select id="filtroStatus" onchange="filtrarChamados()">
          <option value="Todos">Todos</option>
          <option>Pendente</option>
          <option>Em tratativa</option>
          <option>Resolvido</option>
        </select>
      </div>
      <div>
        <label for="filtroPlataforma">Plataforma:</label>
        <select id="filtroPlataforma" onchange="filtrarChamados()">
          <option value="Todas">Todas</option>
          <option>Botmaker</option>
          <option>Olos</option>
          <option>Eaglle</option>
          <option>Lyceum</option>
          <option>Internet</option>
        </select>
      </div>
      <div style="flex: 2 1 300px;">
        <label for="buscaNome">Buscar por nome:</label>
        <input type="text" id="buscaNome" oninput="filtrarChamados()" placeholder="Digite um nome" />
      </div>
    </div>

    <table id="tabelaChamados" aria-label="Tabela de chamados">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Cargo</th>
          <th>Plataforma</th>
          <th>Motivo</th>
          <th>Obs</th>
          <th>Data</th>
          <th>Hora</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button onclick="exportarExcel()">📄 Exportar Excel</button>
  </div>

  <script>
    const senhaCorreta = "admin123";
    const GOOGLE_SHEET_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyaUlvGoiPbYjrfoPHarYnEV4fcx2gzeE-v3cbESxowFXo1V93gBBnp_RUr_Y7M8Zqg/exec";
    let chamados = [];

    const toggleView = (viewId) => {
      ['formView', 'adminView', 'senhaAdmin'].forEach(id =>
        document.getElementById(id).style.display = (id === viewId ? 'flex' : 'none')
      );
      if (viewId === 'adminView') buscarChamados();
    };

    const validarSenha = () => {
      const senha = document.getElementById("senha").value;
      senha === senhaCorreta ? toggleView('adminView') : alert("Senha incorreta.");
    };

    const enviarFormulario = async () => {
      const nome = document.getElementById("nome").value.trim();
      if (!nome) return alert("Preencha o nome.");

      const registro = {
        nome,
        cargo: document.getElementById("cargo").value,
        plataforma: document.getElementById("plataforma").value,
        motivo: document.getElementById("motivo").value,
        obs: document.getElementById("obs").value.trim(),
        data: new Date().toLocaleDateString('pt-BR'),
        hora: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
        status: "Pendente"
      };

      try {
        const res = await fetch(GOOGLE_SHEET_WEBAPP_URL, {
          method: "POST",
          body: JSON.stringify(registro),
          headers: { "Content-Type": "application/json" }
        });
        const json = await res.json();
        if (!res.ok || json.error) throw new Error(json.error || "Erro ao enviar os dados.");

        // O backend retorna o id criado
        registro.id = json.id;

        chamados.push(registro);

        document.querySelectorAll('#formView input, #formView textarea').forEach(el => el.value = '');
        document.getElementById("notificacao").textContent = "✅ Chamado registrado!";
        setTimeout(() => document.getElementById("notificacao").textContent = "", 3000);
      } catch (err) {
        alert("Erro: " + err.message);
      }
    };

    const buscarChamados = async () => {
      try {
        const res = await fetch(GOOGLE_SHEET_WEBAPP_URL);
        chamados = await res.json();
        filtrarChamados();
        renderizarGraficos();
      } catch {
        alert("Erro ao buscar chamados.");
      }
    };

    const filtrarChamados = () => {
      const status = document.getElementById("filtroStatus").value;
      const plataforma = document.getElementById("filtroPlataforma").value;
      const nome = document.getElementById("buscaNome").value.toLowerCase();

      const filtrados = chamados.filter(c =>
        (status === "Todos" || c.status === status) &&
        (plataforma === "Todas" || c.plataforma === plataforma) &&
        c.nome.toLowerCase().includes(nome)
      );
      montarTabela(filtrados);
    };

    const montarTabela = (lista) => {
      const tbody = document.querySelector("#tabelaChamados tbody");
      tbody.innerHTML = lista.length
        ? lista.map(c => `
          <tr class="${c.status.toLowerCase().replace(" ", "")}">
            <td>${c.nome}</td><td>${c.cargo}</td><td>${c.plataforma}</td><td>${c.motivo}</td><td>${c.obs}</td>
            <td>${c.data}</td><td>${c.hora}</td>
            <td>
              <select onchange="alterarStatus('${c.id}', this.value)">
                <option ${c.status === "Pendente" ? "selected" : ""}>Pendente</option>
                <option ${c.status === "Em tratativa" ? "selected" : ""}>Em tratativa</option>
                <option ${c.status === "Resolvido" ? "selected" : ""}>Resolvido</option>
              </select>
            </td>
            <td><button class="btn-table" onclick="copiarProtocolo('${c.id}')">Copiar</button></td>
          </tr>`).join('')
        : `<tr><td colspan="9" style="text-align:center;">Nenhum chamado encontrado.</td></tr>`;
    };

    const alterarStatus = async (id, status) => {
      try {
        const res = await fetch(GOOGLE_SHEET_WEBAPP_URL, {
          method: "POST",
          body: JSON.stringify({ id, status }),
          headers: { "Content-Type": "application/json" }
        });
        const json = await res.json();
        if (!res.ok || json.error) throw new Error(json.error || "Erro ao atualizar status.");

        const chamado = chamados.find(c => c.id === id);
        if (chamado) chamado.status = status;
        filtrarChamados();
        renderizarGraficos();
      } catch {
        alert("Erro ao atualizar status.");
      }
    };

    const copiarProtocolo = (id) => {
      navigator.clipboard.writeText(id)
        .then(() => alert("Protocolo copiado: " + id))
        .catch(() => alert("Erro ao copiar protocolo."));
    };

    const exportarExcel = () => {
      const dados = chamados.map(c => ({
        Protocolo: c.id,
        Nome: c.nome,
        Cargo: c.cargo,
        Plataforma: c.plataforma,
        Motivo: c.motivo,
        Observações: c.obs,
        Data: c.data,
        Hora: c.hora,
        Status: c.status
      }));
      const ws = XLSX.utils.json_to_sheet(dados);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Chamados");
      XLSX.writeFile(wb, "DiarioDeBordo.xlsx");
    };

    let chartStatusInstance = null;
    let chartPlataformaInstance = null;

    const renderizarGraficos = () => {
      const statusContagem = {};
      const plataformaContagem = {};

      chamados.forEach(c => {
        statusContagem[c.status] = (statusContagem[c.status] || 0) + 1;
        plataformaContagem[c.plataforma] = (plataformaContagem[c.plataforma] || 0) + 1;
      });

      // Destroy old charts if exist
      if (chartStatusInstance) chartStatusInstance.destroy();
      if (chartPlataformaInstance) chartPlataformaInstance.destroy();

      const ctxStatus = document.getElementById('chartStatus').getContext('2d');
      chartStatusInstance = new Chart(ctxStatus, {
        type: 'doughnut',
        data: {
          labels: Object.keys(statusContagem),
          datasets: [{
            label: 'Status',
            data: Object.values(statusContagem),
            backgroundColor: ['#ffc107', '#17a2b8', '#28a745'],
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            title: { display: true, text: 'Distribuição por Status' }
          }
        }
      });

      const ctxPlataforma = document.getElementById('chartPlataforma').getContext('2d');
      chartPlataformaInstance = new Chart(ctxPlataforma, {
        type: 'bar',
        data: {
          labels: Object.keys(plataformaContagem),
          datasets: [{
            label: 'Plataforma',
            data: Object.values(plataformaContagem),
            backgroundColor: '#007bff',
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: true, text: 'Distribuição por Plataforma' }
          },
          scales: {
            y: { beginAtZero: true, precision: 0 }
          }
        }
      });
    };

    window.onload = () => {
      toggleView('formView');
    };
  </script>
</body>
</html>
   
