<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Diário de Bordo - Corporativo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* ... [ESTILOS CSS - já otimizados na versão anterior, mantidos no seu código] ... */
  </style>
</head>
<body>
  <header>
    <div class="logo uva">Universidade Veiga de Almeida</div>
    <div class="logo unijorge">Unijorge</div>
  </header>

  <nav>
    <button onclick="toggleView('formView')">📋 Diário de Bordo</button>
    <button onclick="mostrarCampoSenha()">🔒 Admin</button>
  </nav>

  <!-- Formulário -->
  <div id="formView">
    <h2>Registro - Diário de Bordo</h2>
    <label for="nome">Nome:</label>
    <input type="text" id="nome" autocomplete="off">

    <label for="cargo">Cargo:</label>
    <select id="cargo">
      <option>Consultor</option>
      <option>Assistente</option>
      <option>Analista</option>
      <option>Coordenador</option>
      <option>Gerência</option>
    </select>

    <label for="plataforma">Plataforma:</label>
    <select id="plataforma">
      <option>Botmaker</option>
      <option>Olos</option>
      <option>Eaglle</option>
      <option>Lyceum</option>
      <option>Internet</option>
    </select>

    <label for="motivo">Motivo do chamado:</label>
    <select id="motivo">
      <option>Queda</option>
      <option>Instabilidade</option>
      <option>Não consigo acessar</option>
      <option>Sem internet</option>
      <option>Não consigo conectar</option>
      <option>Outro</option>
    </select>

    <label for="obs">Observações:</label>
    <textarea id="obs" rows="3"></textarea>

    <button onclick="enviarFormulario()">🚀 Enviar</button>
    <div id="notificacao"></div>
  </div>

  <!-- Senha Admin -->
  <div id="senhaAdmin">
    <h2>🔐 Acesso Restrito</h2>
    <label for="senha">Digite a senha de administrador:</label>
    <input type="password" id="senha" placeholder="Senha" autocomplete="off">
    <button onclick="validarSenha()">Entrar</button>
  </div>

  <!-- Painel Administrativo -->
  <div id="adminView">
    <h2>📊 Painel Administrativo</h2>
    <div>
      <label for="filtroStatus">Filtrar por status:</label>
      <select id="filtroStatus" onchange="filtrarChamados()">
        <option value="Todos">Todos</option>
        <option value="Pendente">Pendente</option>
        <option value="Em tratativa">Em tratativa</option>
        <option value="Resolvido">Resolvido</option>
      </select>

      <label for="filtroPlataforma">Plataforma:</label>
      <select id="filtroPlataforma" onchange="filtrarChamados()">
        <option value="Todas">Todas</option>
        <option>Botmaker</option>
        <option>Olos</option>
        <option>Eaglle</option>
        <option>Lyceum</option>
        <option>Internet</option>
      </select>

      <label for="buscaNome">Buscar por nome:</label>
      <input type="text" id="buscaNome" oninput="filtrarChamados()" placeholder="Digite um nome">
    </div>

    <table id="tabelaChamados">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Cargo</th>
          <th>Plataforma</th>
          <th>Motivo</th>
          <th>Obs</th>
          <th>Data</th>
          <th>Hora</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button onclick="exportarExcel()">📄 Exportar para Excel</button>
  </div>

  <script>
    const senhaCorreta = "admin123";
    const GOOGLE_SHEET_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyaUlvGoiPbYjrfoPHarYnEV4fcx2gzeE-v3cbESxowFXo1V93gBBnp_RUr_Y7M8Zqg/exec";
    let chamados = [];

    function toggleView(viewId) {
      document.getElementById('formView').style.display = 'none';
      document.getElementById('adminView').style.display = 'none';
      document.getElementById('senhaAdmin').style.display = 'none';
      document.getElementById(viewId).style.display = 'flex';
    }

    function mostrarCampoSenha() {
      toggleView('senhaAdmin');
    }

    function validarSenha() {
      const senha = document.getElementById("senha").value;
      if (senha === senhaCorreta) {
        toggleView('adminView');
        buscarChamados();
      } else {
        alert("Senha incorreta.");
      }
    }

    async function enviarFormulario() {
      const nome = document.getElementById("nome").value.trim();
      const cargo = document.getElementById("cargo").value;
      const plataforma = document.getElementById("plataforma").value;
      const motivo = document.getElementById("motivo").value;
      const obs = document.getElementById("obs").value.trim();
      if (!nome) return alert("Por favor, preencha o nome.");

      const dataAtual = new Date();
      const data = dataAtual.toLocaleDateString('pt-BR');
      const hora = dataAtual.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
      const id = Date.now() + "-" + Math.floor(Math.random() * 1000);
      const registro = { id, nome, cargo, plataforma, motivo, obs, data, hora, status: "Pendente" };

      try {
        const res = await fetch(GOOGLE_SHEET_WEBAPP_URL, {
          method: "POST",
          body: JSON.stringify(registro),
          headers: { "Content-Type": "application/json" }
        });
        if (!res.ok) throw new Error("Erro ao enviar os dados.");
        document.querySelectorAll('#formView input[type=text], #formView textarea').forEach(el => el.value = '');
        document.getElementById("notificacao").textContent = "✅ Chamado registrado com sucesso!";
        setTimeout(() => document.getElementById("notificacao").textContent = "", 4000);
      } catch (err) {
        alert(err.message);
      }
    }

    async function buscarChamados() {
      try {
        const res = await fetch(GOOGLE_SHEET_WEBAPP_URL);
        chamados = await res.json();
        filtrarChamados();
      } catch {
        alert("Erro ao buscar chamados.");
      }
    }

    function filtrarChamados() {
      const status = document.getElementById("filtroStatus").value;
      const plataforma = document.getElementById("filtroPlataforma").value;
      const nome = document.getElementById("buscaNome").value.toLowerCase();

      const filtrados = chamados.filter(c =>
        (status === "Todos" || c.status === status) &&
        (plataforma === "Todas" || c.plataforma === plataforma) &&
        c.nome.toLowerCase().includes(nome)
      );
      montarTabela(filtrados);
    }

    function montarTabela(lista) {
      const tbody = document.querySelector("#tabelaChamados tbody");
      tbody.innerHTML = "";
      if (!lista.length) return tbody.innerHTML = `<tr><td colspan="9" style="text-align:center">Nenhum chamado encontrado.</td></tr>`;
      lista.forEach(c => {
        const tr = document.createElement("tr");
        tr.className = c.status === "Pendente" ? "pendente" : c.status === "Em tratativa" ? "tratativa" : "resolvido";
        tr.innerHTML = `
          <td>${c.nome}</td>
          <td>${c.cargo}</td>
          <td>${c.plataforma}</td>
          <td>${c.motivo}</td>
          <td>${c.obs}</td>
          <td>${c.data}</td>
          <td>${c.hora}</td>
          <td>
            <select onchange="alterarStatus('${c.id}', this.value)">
              <option ${c.status === "Pendente" ? "selected" : ""}>Pendente</option>
              <option ${c.status === "Em tratativa" ? "selected" : ""}>Em tratativa</option>
              <option ${c.status === "Resolvido" ? "selected" : ""}>Resolvido</option>
            </select>
          </td>
          <td><button class="btn-table" onclick="copiarProtocolo('${c.id}')">Copiar Protocolo</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function alterarStatus(id, status) {
      try {
        const res = await fetch(GOOGLE_SHEET_WEBAPP_URL, {
          method: "POST",
          body: JSON.stringify({ id, status }),
          headers: { "Content-Type": "application/json" }
        });
        if (!res.ok) throw new Error();
        const chamado = chamados.find(c => c.id === id);
        if (chamado) chamado.status = status;
        filtrarChamados();
      } catch {
        alert("Erro ao atualizar status.");
      }
    }

    function copiarProtocolo(id) {
      navigator.clipboard.writeText(id)
        .then(() => alert("Protocolo copiado: " + id))
        .catch(() => alert("Erro ao copiar protocolo."));
    }

    function exportarExcel() {
      const dados = chamados.map(c => ({
        Protocolo: c.id,
        Nome: c.nome,
        Cargo: c.cargo,
        Plataforma: c.plataforma,
        Motivo: c.motivo,
        Observações: c.obs,
        Data: c.data,
        Hora: c.hora,
        Status: c.status
      }));
      const ws = XLSX.utils.json_to_sheet(dados);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Chamados");
      XLSX.writeFile(wb, "DiarioDeBordo.xlsx");
    }

    window.onload = () => toggleView('formView');
  </script>
</body>
</html>
