<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Diário de Bordo - Corporativo</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    /* Reset básico */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Inter', Arial, sans-serif;
      background-color: #f5f7fa;
      color: #1f3a5f;
      min-height: 100vh;
      padding: 30px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      user-select: none;
    }

    /* Cabeçalho */
    header {
      width: 100%;
      max-width: 900px;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #1f3a5f;
      font-weight: 700;
      font-size: 1.25rem;
      letter-spacing: 1.5px;
    }
    header .logo {
      font-family: 'Inter', sans-serif;
    }

    nav {
      margin-bottom: 25px;
      width: 100%;
      max-width: 900px;
      display: flex;
      justify-content: center;
      gap: 18px;
      z-index: 10;
      position: relative;
    }
    nav button {
      background-color: #4a5a70;
      border: none;
      border-radius: 8px;
      padding: 14px 32px;
      color: white;
      font-weight: 700;
      cursor: pointer;
      font-size: 1.1rem;
      transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.15s ease;
      user-select: none;
      box-shadow: 0 6px 16px rgba(74,90,112,0.4);
      display: flex;
      align-items: center;
      gap: 8px;
      filter: drop-shadow(0 0 0 transparent);
    }
    nav button:hover {
      background-color: #1f3a5f;
      box-shadow: 0 10px 30px rgba(31,58,95,0.7);
      transform: translateY(-3px);
      filter: drop-shadow(0 4px 4px rgba(31,58,95,0.4));
    }
    nav button:active {
      transform: translateY(1px);
      box-shadow: none;
      filter: drop-shadow(0 0 0 transparent);
    }

    /* Contêineres */
    #formView, #adminView, #senhaAdmin {
      background-color: #ffffff;
      border-radius: 12px;
      padding: 32px 40px;
      max-width: 900px;
      width: 100%;
      box-shadow: 0 12px 32px rgba(31,58,95,0.15);
      color: #1f3a5f;
      display: none;
      flex-direction: column;
      position: relative;
      user-select: text;
    }

    h2 {
      color: #1f3a5f;
      margin-bottom: 28px;
      font-weight: 700;
      font-size: 2rem;
      text-align: center;
      letter-spacing: 1.2px;
      user-select: none;
    }

    label {
      font-weight: 600;
      margin-top: 20px;
      display: block;
      color: #4a5a70;
      font-size: 1rem;
      user-select: none;
    }

    input[type=text],
    input[type=password],
    select,
    textarea {
      width: 100%;
      padding: 14px 18px;
      margin-top: 8px;
      border-radius: 8px;
      border: 1.8px solid #d1d9e6;
      font-size: 1rem;
      background-color: #fefefe;
      color: #1f3a5f;
      font-family: 'Inter', sans-serif;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      resize: vertical;
      box-shadow: inset 0 0 8px rgba(31,58,95,0.1);
      user-select: text;
    }
    input[type=text]:focus,
    input[type=password]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #1f3a5f;
      box-shadow: 0 0 14px rgba(31,58,95,0.4);
      background-color: #ffffff;
      color: #1f3a5f;
    }

    /* Botões */
    button {
      background-color: #4a5a70;
      border: none;
      border-radius: 10px;
      padding: 16px 36px;
      margin-top: 36px;
      color: white;
      font-weight: 700;
      cursor: pointer;
      font-size: 1.2rem;
      transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.15s ease;
      user-select: none;
      box-shadow: 0 8px 24px rgba(74,90,112,0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }
    button:hover {
      background-color: #1f3a5f;
      box-shadow: 0 14px 36px rgba(31,58,95,0.7);
      transform: translateY(-4px);
    }
    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    /* Tabela Admin */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 36px;
      color: #1f3a5f;
      font-size: 1rem;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 28px rgba(31,58,95,0.15);
    }
    thead {
      background-color: #2c4664;
    }
    thead th {
      padding: 16px 14px;
      text-align: left;
      font-weight: 700;
      border-bottom: 3px solid #18314f;
      color: #e6f0ff;
      letter-spacing: 0.9px;
      user-select: none;
    }
    tbody tr {
      border-bottom: 1px solid #dbe1ec;
      transition: background-color 0.25s ease;
    }
    tbody tr:hover {
      background-color: #dce7f7;
    }
    tbody td {
      padding: 16px 14px;
      vertical-align: middle;
      user-select: text;
    }

    /* Status cores */
    tbody tr.pendente {
      background-color: #fef1f1;
      color: #a42b2b;
      font-weight: 600;
    }
    tbody tr.tratativa {
      background-color: #fff8e5;
      color: #a67c00;
      font-weight: 600;
    }
    tbody tr.resolvido {
      background-color: #e6f0ff;
      color: #2a4da0;
      font-weight: 600;
    }

    /* Botões ação na tabela */
    .btn-table {
      background-color: #4a5a70;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 18px;
      font-weight: 700;
      cursor: pointer;
      margin-right: 10px;
      font-size: 1rem;
      transition: background-color 0.3s ease, transform 0.15s ease;
      user-select: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-table:hover {
      background-color: #1f3a5f;
    }
    .btn-table:active {
      transform: scale(0.95);
    }

    /* Filtros no admin */
    #adminView > div {
      display: flex;
      flex-wrap: wrap;
      gap: 28px;
      margin-bottom: 28px;
      align-items: center;
      justify-content: start;
    }
    #adminView label {
      margin: 0;
      font-weight: 600;
      color: #4a5a70;
      font-size: 1rem;
      min-width: 140px;
      user-select: none;
    }
    #adminView select,
    #adminView input[type=text] {
      max-width: 220px;
      padding: 12px 18px;
      border-radius: 8px;
      border: 1.8px solid #d1d9e6;
      background-color: #fafbfc;
      color: #1f3a5f;
      font-family: 'Inter', sans-serif;
      transition: border-color 0.3s ease;
      font-size: 1rem;
      user-select: text;
    }
    #adminView select:hover,
    #adminView input[type=text]:hover {
      border-color: #1f3a5f;
    }
    #adminView input[type=text]:focus,
    #adminView select:focus {
      outline: none;
      border-color: #1f3a5f;
      box-shadow: 0 0 14px rgba(31,58,95,0.4);
      color: #1f3a5f;
      background-color: #fff;
    }

    /* Notificação sucesso */
    #notificacao {
      color: #1f3a5f;
      font-weight: 700;
      font-size: 1.2rem;
      margin-top: 20px;
      text-align: center;
      user-select: none;
      min-height: 30px;
    }

    /* Responsivo */
    @media (max-width: 720px) {
      header {
        flex-direction: column;
        gap: 14px;
        text-align: center;
      }
      nav {
        flex-direction: column;
      }
      #adminView > div {
        flex-direction: column;
        align-items: stretch;
      }
      #adminView select, #adminView input[type=text] {
        max-width: 100%;
      }
      button {
        width: 100%;
        font-size: 1.1rem;
      }
      .btn-table {
        width: 100%;
        justify-content: center;
        margin-bottom: 8px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo uva">Universidade Veiga de Almeida</div>
    <div class="logo unijorge">Unijorge</div>
  </header>

  <nav>
    <button onclick="toggleView('formView')">📋 Diário de Bordo</button>
    <button onclick="mostrarCampoSenha()">🔒 Admin</button>
  </nav>

  <!-- Formulário -->
  <div id="formView">
    <h2>Registro - Diário de Bordo</h2>
    <label for="nome">Nome:</label>
    <input type="text" id="nome" autocomplete="off" />

    <label for="cargo">Cargo:</label>
    <select id="cargo">
      <option>Consultor</option>
      <option>Assistente</option>
      <option>Analista</option>
      <option>Coordenador</option>
      <option>Gerência</option>
    </select>

    <label for="plataforma">Plataforma:</label>
    <select id="plataforma">
      <option>Botmaker</option>
      <option>Olos</option>
      <option>Eaglle</option>
      <option>Lyceum</option>
      <option>Internet</option>
    </select>

    <label for="motivo">Motivo do chamado:</label>
    <select id="motivo">
      <option>Queda</option>
      <option>Instabilidade</option>
      <option>Não consigo acessar</option>
      <option>Sem internet</option>
      <option>Não consigo conectar</option>
      <option>Outro</option>
    </select>

    <label for="obs">Observações:</label>
    <textarea id="obs" rows="3"></textarea>

    <button onclick="enviarFormulario()">🚀 Enviar</button>
    <div id="notificacao"></div>
  </div>

  <!-- Login senha admin -->
  <div id="senhaAdmin">
    <h2>🔐 Acesso Restrito</h2>
    <label for="senha">Digite a senha de administrador:</label>
    <input type="password" id="senha" placeholder="Senha" autocomplete="off" />
    <button onclick="validarSenha()">Entrar</button>
  </div>

  <!-- Painel Administrativo -->
  <div id="adminView">
    <h2>📊 Painel Administrativo</h2>

    <div>
      <label for="filtroStatus">Filtrar por status:</label>
      <select id="filtroStatus" onchange="filtrarChamados()">
        <option value="Todos">Todos</option>
        <option value="Pendente">Pendente</option>
        <option value="Em tratativa">Em tratativa</option>
        <option value="Resolvido">Resolvido</option>
      </select>

      <label for="filtroPlataforma">Plataforma:</label>
      <select id="filtroPlataforma" onchange="filtrarChamados()">
        <option value="Todas">Todas</option>
        <option>Botmaker</option>
        <option>Olos</option>
        <option>Eaglle</option>
        <option>Lyceum</option>
        <option>Internet</option>
      </select>

      <label for="buscaNome">Buscar por nome:</label>
      <input type="text" id="buscaNome" oninput="filtrarChamados()" placeholder="Digite um nome" />
    </div>

    <table id="tabelaChamados" aria-label="Tabela de chamados">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Cargo</th>
          <th>Plataforma</th>
          <th>Motivo</th>
          <th>Obs</th>
          <th>Data</th>
          <th>Hora</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="exportarExcel()">📄 Exportar para Excel</button>
  </div>

  <script>
    const senhaCorreta = "admin123";
    const GOOGLE_SHEET_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwqWEWqFIJWB2AMmqwifv17CQm4H9iZ0wejWT0a0FauKaeIXRXuxTlsgAtrB5pbObxB/exec";

    let chamados = [];

    // Alterna visibilidade das views
    function toggleView(viewId) {
      document.getElementById('formView').style.display = 'none';
      document.getElementById('adminView').style.display = 'none';
      document.getElementById('senhaAdmin').style.display = 'none';
      document.getElementById(viewId).style.display = 'flex';
    }

    // Mostrar campo senha para admin
    function mostrarCampoSenha() {
      toggleView('senhaAdmin');
    }

    // Valida senha e abre painel admin
    function validarSenha() {
      const senha = document.getElementById("senha").value;
      if (senha === senhaCorreta) {
        toggleView('adminView');
        buscarChamados();
      } else {
        alert("Senha incorreta.");
      }
    }

    // Enviar formulário para Google Sheets via POST
    async function enviarFormulario() {
      const nome = document.getElementById("nome").value.trim();
      const cargo = document.getElementById("cargo").value;
      const plataforma = document.getElementById("plataforma").value;
      const motivo = document.getElementById("motivo").value;
      const obs = document.getElementById("obs").value.trim();

      if (!nome) {
        alert("Por favor, preencha o nome.");
        return;
      }

      const dataAtual = new Date();
      const data = dataAtual.toLocaleDateString('pt-BR');
      const hora = dataAtual.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

      // Criar um id único simples (timestamp + aleatório)
      const id = Date.now() + "-" + Math.floor(Math.random() * 1000);

      const registro = {
        id, nome, cargo, plataforma, motivo, obs, data, hora, status: "Pendente"
      };

      try {
        const res = await fetch(GOOGLE_SHEET_WEBAPP_URL, {
          method: "POST",
          body: JSON.stringify(registro),
          headers: { "Content-Type": "application/json" }
        });

        if (!res.ok) throw new Error("Erro ao enviar os dados.");

        // Limpar formulário e mostrar sucesso
        document.querySelectorAll('#formView input[type=text], #formView textarea').forEach(el => el.value = '');
        document.getElementById("notificacao").textContent = "✅ Chamado registrado com sucesso!";
        setTimeout(() => document.getElementById("notificacao").textContent = "", 4000);
      } catch (err) {
        alert(err.message || "Erro na conexão com o Google Sheets.");
      }
    }

    // Buscar chamados do Google Sheets via GET
    async function buscarChamados() {
      try {
        const res = await fetch(GOOGLE_SHEET_WEBAPP_URL);
        chamados = await res.json();
        filtrarChamados();
      } catch {
        alert("Erro ao buscar chamados do Google Sheets.");
      }
    }

  // Filtrar e atualizar tabela
  function filtrarChamados() {
    const filtroStatus = document.getElementById("filtroStatus").value;
    const filtroPlataforma = document.getElementById("filtroPlataforma").value;
    const buscaNome = document.getElementById("buscaNome").value.toLowerCase();

    const filtrados = chamados.filter(c => {
      // Filtra status
      const statusOK = filtroStatus === "Todos" || c.status === filtroStatus;
      // Filtra plataforma
      const plataformaOK = filtroPlataforma === "Todas" || c.plataforma === filtroPlataforma;
      // Filtra nome
      const nomeOK = c.nome.toLowerCase().includes(buscaNome);

      return statusOK && plataformaOK && nomeOK;
    });

    montarTabela(filtrados);
  }

  // Monta a tabela na tela com os dados filtrados
  function montarTabela(lista) {
    const tbody = document.querySelector("#tabelaChamados tbody");
    tbody.innerHTML = "";

    if (lista.length === 0) {
      tbody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding:20px;">Nenhum chamado encontrado.</td></tr>`;
      return;
    }

    lista.forEach(c => {
      const tr = document.createElement("tr");

      // Classe para colorir status
      let classeStatus = "";
      if (c.status === "Pendente") classeStatus = "pendente";
      else if (c.status === "Em tratativa") classeStatus = "tratativa";
      else if (c.status === "Resolvido") classeStatus = "resolvido";
      tr.classList.add(classeStatus);

      tr.innerHTML = `
        <td>${c.nome}</td>
        <td>${c.cargo}</td>
        <td>${c.plataforma}</td>
        <td>${c.motivo}</td>
        <td>${c.obs}</td>
        <td>${c.data}</td>
        <td>${c.hora}</td>
        <td>
          <select onchange="alterarStatus('${c.id}', this.value)">
            <option value="Pendente" ${c.status === "Pendente" ? "selected" : ""}>Pendente</option>
            <option value="Em tratativa" ${c.status === "Em tratativa" ? "selected" : ""}>Em tratativa</option>
            <option value="Resolvido" ${c.status === "Resolvido" ? "selected" : ""}>Resolvido</option>
          </select>
        </td>
        <td>
          <button class="btn-table" onclick="copiarProtocolo('${c.id}')">Copiar Protocolo</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Atualiza o status no Google Sheets via POST
  async function alterarStatus(id, novoStatus) {
    try {
      const res = await fetch(GOOGLE_SHEET_WEBAPP_URL, {
        method: "POST",
        body: JSON.stringify({ id, status: novoStatus }),
        headers: { "Content-Type": "application/json" }
      });
      if (!res.ok) throw new Error("Erro ao atualizar status.");

      // Atualiza localmente o status no array
      const idx = chamados.findIndex(c => c.id === id);
      if (idx > -1) {
        chamados[idx].status = novoStatus;
        filtrarChamados();
      }
    } catch (err) {
      alert(err.message || "Erro na atualização do status.");
    }
  }

  // Copiar protocolo (id) para área de transferência
  function copiarProtocolo(id) {
    navigator.clipboard.writeText(id).then(() => {
      alert("Protocolo copiado: " + id);
    }).catch(() => {
      alert("Erro ao copiar protocolo.");
    });
  }

  // Exportar dados filtrados para Excel (.xlsx)
  function exportarExcel() {
    const filtroStatus = document.getElementById("filtroStatus").value;
    const filtroPlataforma = document.getElementById("filtroPlataforma").value;
    const buscaNome = document.getElementById("buscaNome").value.toLowerCase();

    const filtrados = chamados.filter(c => {
      const statusOK = filtroStatus === "Todos" || c.status === filtroStatus;
      const plataformaOK = filtroPlataforma === "Todas" || c.plataforma === filtroPlataforma;
      const nomeOK = c.nome.toLowerCase().includes(buscaNome);
      return statusOK && plataformaOK && nomeOK;
    });

    if (filtrados.length === 0) {
      alert("Nenhum dado para exportar.");
      return;
    }

    // Prepara dados para Excel
    const dadosExcel = filtrados.map(c => ({
      Protocolo: c.id,
      Nome: c.nome,
      Cargo: c.cargo,
      Plataforma: c.plataforma,
      Motivo: c.motivo,
      Observações: c.obs,
      Data: c.data,
      Hora: c.hora,
      Status: c.status
    }));

    const ws = XLSX.utils.json_to_sheet(dadosExcel);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Chamados");
    XLSX.writeFile(wb, "DiarioDeBordo.xlsx");
  }

  // Ao carregar a página, mostrar o formulário por padrão
  window.onload = () => {
    toggleView('formView');
  };
</script>

