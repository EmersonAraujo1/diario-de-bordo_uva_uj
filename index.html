<script>
  const senhaCorreta = "admin123";
  const GOOGLE_SHEET_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyaUlvGoiPbYjrfoPHarYnEV4fcx2gzeE-v3cbESxowFXo1V93gBBnp_RUr_Y7M8Zqg/exec";

  function toggleView(viewId) {
    document.getElementById('formView').style.display = 'none';
    document.getElementById('adminView').style.display = 'none';
    document.getElementById('senhaAdmin').style.display = 'none';
    document.getElementById(viewId).style.display = 'flex';
  }

  function mostrarCampoSenha() {
    toggleView('senhaAdmin');
  }

  function validarSenha() {
    const senha = document.getElementById("senha").value;
    if (senha === senhaCorreta) {
      toggleView('adminView');
      atualizarTabela();
    } else {
      alert("Senha incorreta.");
    }
  }

  function enviarFormulario() {
    const nome = document.getElementById("nome").value.trim();
    const cargo = document.getElementById("cargo").value;
    const plataforma = document.getElementById("plataforma").value;
    const motivo = document.getElementById("motivo").value;
    const obs = document.getElementById("obs").value.trim();

    if (!nome) {
      alert("Por favor, preencha o nome.");
      return;
    }

    const dataAtual = new Date();
    const data = dataAtual.toLocaleDateString('pt-BR');
    const hora = dataAtual.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

    const registro = {
      nome, cargo, plataforma, motivo, obs, data, hora, status: "Pendente"
    };

    fetch(GOOGLE_SHEET_WEBAPP_URL, {
      method: "POST",
      body: JSON.stringify(registro),
      headers: { "Content-Type": "application/json" }
    })
    .then(res => {
      if (res.ok) {
        document.querySelectorAll('#formView input[type=text], #formView textarea').forEach(el => el.value = '');
        document.getElementById("notificacao").textContent = "âœ… Chamado registrado com sucesso!";
        setTimeout(() => document.getElementById("notificacao").textContent = "", 4000);
      } else {
        alert("Erro ao enviar os dados.");
      }
    })
    .catch(() => alert("Erro na conexÃ£o com o Google Sheets."));
  }

  function atualizarTabela() {
    fetch(GOOGLE_SHEET_WEBAPP_URL)
      .then(res => res.json())
      .then(chamados => {
        const filtroStatus = document.getElementById("filtroStatus")?.value || "Todos";
        const filtroPlataforma = document.getElementById("filtroPlataforma")?.value || "Todas";
        const buscaNome = document.getElementById("buscaNome")?.value.toLowerCase() || "";

        const tbody = document.querySelector("#tabelaChamados tbody");
        tbody.innerHTML = "";

        chamados.forEach((c, i) => {
          if (filtroStatus !== "Todos" && c.status !== filtroStatus) return;
          if (filtroPlataforma !== "Todas" && c.plataforma !== filtroPlataforma) return;
          if (buscaNome && !c.nome.toLowerCase().includes(buscaNome)) return;

          const tr = document.createElement("tr");
          tr.className = c.status === "Pendente" ? "pendente"
            : c.status === "Em tratativa" ? "tratativa"
            : "resolvido";

          tr.innerHTML = `
            <td>${c.nome}</td>
            <td>${c.cargo}</td>
            <td>${c.plataforma}</td>
            <td>${c.motivo}</td>
            <td>${c.obs}</td>
            <td>${c.data}</td>
            <td>${c.hora}</td>
            <td>${c.status}</td>
            <td>ðŸ”’</td>
          `;
          tbody.appendChild(tr);
        });
      });
  }

  function exportarExcel() {
    fetch(GOOGLE_SHEET_WEBAPP_URL)
      .then(res => res.json())
      .then(chamados => {
        const filtroStatus = document.getElementById("filtroStatus").value;
        const filtroPlataforma = document.getElementById("filtroPlataforma").value;
        const buscaNome = document.getElementById("buscaNome").value.toLowerCase();

        const filtrados = chamados.filter(c => {
          if (filtroStatus !== "Todos" && c.status !== filtroStatus) return false;
          if (filtroPlataforma !== "Todas" && c.plataforma !== filtroPlataforma) return false;
          if (buscaNome && !c.nome.toLowerCase().includes(buscaNome)) return false;
          return true;
        });

        const ws_data = [
          ["Nome", "Cargo", "Plataforma", "Motivo", "ObservaÃ§Ãµes", "Data", "Hora", "Status"],
          ...filtrados.map(c => [c.nome, c.cargo, c.plataforma, c.motivo, c.obs, c.data, c.hora, c.status])
        ];

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, "Chamados");
        XLSX.writeFile(wb, "diario_de_bordo.xlsx");
      });
  }

  toggleView('formView');
</script>
