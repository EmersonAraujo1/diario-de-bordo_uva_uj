<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Diário de Bordo - Corporativo</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    /* Reset básico */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Inter', Arial, sans-serif;
      background-color: #f5f7fa;
      color: #1f3a5f;
      min-height: 100vh;
      padding: 30px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      user-select: none;
    }
    header {
      width: 100%;
      max-width: 900px;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #1f3a5f;
      font-weight: 700;
      font-size: 1.25rem;
      letter-spacing: 1.5px;
    }
    header .logo {
      font-family: 'Inter', sans-serif;
    }
    nav {
      margin-bottom: 25px;
      width: 100%;
      max-width: 900px;
      display: flex;
      justify-content: center;
      gap: 18px;
      z-index: 10;
      position: relative;
      flex-wrap: wrap;
    }
    nav button {
      background-color: #4a5a70;
      border: none;
      border-radius: 6px;
      padding: 12px 30px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.25s ease;
      user-select: none;
      box-shadow: 0 3px 6px rgba(74,90,112,0.3);
      min-width: 150px;
      flex: 1 1 auto;
    }
    nav button:hover {
      background-color: #1f3a5f;
      box-shadow: 0 4px 8px rgba(31,58,95,0.5);
    }
    #formView, #adminView, #senhaAdmin {
      background-color: #fff;
      border-radius: 10px;
      padding: 30px 35px;
      max-width: 900px;
      width: 100%;
      box-shadow: 0 8px 20px rgba(31,58,95,0.1);
      color: #1f3a5f;
      display: none;
      flex-direction: column;
      position: relative;
      user-select: text;
    }
    h2 {
      color: #1f3a5f;
      margin-bottom: 25px;
      font-weight: 700;
      font-size: 2rem;
      text-align: center;
      letter-spacing: 1.2px;
    }
    label {
      font-weight: 600;
      margin-top: 18px;
      display: block;
      color: #4a5a70;
      font-size: 1rem;
    }
    input[type=text],
    input[type=password],
    select,
    textarea {
      width: 100%;
      padding: 12px 15px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1.8px solid #d1d9e6;
      font-size: 1rem;
      background-color: #fefefe;
      color: #1f3a5f;
      font-family: 'Inter', sans-serif;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      resize: vertical;
      box-shadow: inset 0 0 6px rgba(31,58,95,0.1);
    }
    input[type=text]:focus,
    input[type=password]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #1f3a5f;
      box-shadow: 0 0 10px rgba(31,58,95,0.3);
      background-color: #fff;
      color: #1f3a5f;
    }
    button {
      background-color: #4a5a70;
      border: none;
      border-radius: 8px;
      padding: 14px 30px;
      margin-top: 30px;
      color: white;
      font-weight: 700;
      cursor: pointer;
      font-size: 1.1rem;
      transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.1s ease;
      user-select: none;
      box-shadow: 0 4px 10px rgba(74,90,112,0.3);
      min-width: 150px;
    }
    button:hover {
      background-color: #1f3a5f;
      box-shadow: 0 6px 18px rgba(31,58,95,0.5);
      transform: translateY(-2px);
    }
    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
      color: #1f3a5f;
      font-size: 1rem;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(31,58,95,0.1);
    }
    thead {
      background-color: #e1e6f0;
    }
    thead th {
      padding: 14px 12px;
      text-align: left;
      font-weight: 700;
      border-bottom: 2px solid #c0c7d6;
      color: #1f3a5f;
      letter-spacing: 0.8px;
    }
    tbody tr {
      border-bottom: 1px solid #dbe1ec;
      transition: background-color 0.3s ease;
    }
    tbody tr:hover {
      background-color: #f0f4fb;
    }
    tbody td {
      padding: 14px 10px;
      vertical-align: middle;
    }
    tbody tr.pendente {
      background-color: #fef1f1;
      color: #a42b2b;
      font-weight: 600;
    }
    tbody tr.tratativa {
      background-color: #fff8e5;
      color: #a67c00;
      font-weight: 600;
    }
    tbody tr.resolvido {
      background-color: #e6f0ff;
      color: #2a4da0;
      font-weight: 600;
    }
    .btn-table {
      background-color: #4a5a70;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 7px 16px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 8px;
      font-size: 0.9rem;
      transition: background-color 0.3s ease;
      user-select: none;
      min-width: 90px;
    }
    .btn-table:hover {
      background-color: #1f3a5f;
    }
    .btn-table:active {
      transform: scale(0.95);
    }
    #adminView > div {
      display: flex;
      flex-wrap: wrap;
      gap: 22px;
      margin-bottom: 20px;
      align-items: center;
      justify-content: start;
    }
    #adminView label {
      margin: 0;
      font-weight: 600;
      color: #4a5a70;
      font-size: 1rem;
      min-width: 130px;
    }
    #adminView select,
    #adminView input[type=text] {
      max-width: 200px;
      padding: 10px 14px;
      border-radius: 6px;
      border: 1.8px solid #d1d9e6;
      background-color: #fafbfc;
      color: #1f3a5f;
      font-family: 'Inter', sans-serif;
      transition: border-color 0.3s ease;
      font-size: 1rem;
    }
    #adminView select:hover,
    #adminView input[type=text]:hover {
      border-color: #1f3a5f;
    }
    #adminView input[type=text]:focus,
    #adminView select:focus {
      outline: none;
      border-color: #1f3a5f;
      box-shadow: 0 0 10px rgba(31,58,95,0.3);
      color: #1f3a5f;
      background-color: #fff;
    }
    #notificacao {
      color: #1f3a5f;
      font-weight: 700;
      font-size: 1.1rem;
      margin-top: 15px;
      text-align: center;
      user-select: none;
      min-height: 28px;
      min-width: 300px;
      transition: opacity 0.4s ease;
    }
    @media (max-width: 720px) {
      header {
        flex-direction: column;
        gap: 12px;
        text-align: center;
      }
      nav {
        flex-direction: column;
      }
      #adminView > div {
        flex-direction: column;
        align-items: stretch;
      }
      #adminView select, #adminView input[type=text] {
        max-width: 100%;
      }
      button {
        width: 100%;
        font-size: 1rem;
        min-width: auto;
      }
      nav button {
        min-width: auto;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo uva">Universidade Veiga de Almeida</div>
    <div class="logo unijorge">Unijorge</div>
  </header>

  <nav>
    <button onclick="toggleView('formView')">📋 Diário de Bordo</button>
    <button onclick="mostrarCampoSenha()">🔒 Admin</button>
  </nav>

  <section id="formView" style="display:flex; flex-direction: column;">
    <h2>Registro - Diário de Bordo</h2>

    <label for="nome">Nome:</label>
    <input type="text" id="nome" autocomplete="off" />

    <label for="cargo">Cargo:</label>
    <select id="cargo">
      <option>Consultor</option>
      <option>Assistente</option>
      <option>Analista</option>
      <option>Coordenador</option>
      <option>Gerência</option>
    </select>

    <label for="plataforma">Plataforma:</label>
    <select id="plataforma">
      <option>Botmaker</option>
      <option>Olos</option>
      <option>Eaglle</option>
      <option>Lyceum</option>
      <option>Internet</option>
    </select>

    <label for="motivo">Motivo do chamado:</label>
    <select id="motivo">
      <option>Queda</option>
      <option>Instabilidade</option>
      <option>Não consigo acessar</option>
      <option>Sem internet</option>
      <option>Não consigo conectar</option>
      <option>Outro</option>
    </select>

    <label for="obs">Observações:</label>
    <textarea id="obs" rows="3"></textarea>

    <button id="btnEnviar">🚀 Enviar</button>
    <div id="notificacao" aria-live="polite" role="status"></div>
  </section>

  <section id="senhaAdmin" style="display:none; flex-direction: column;">
    <h2>🔐 Acesso Restrito</h2>
    <label for="senha">Digite a senha de administrador:</label>
    <input type="password" id="senha" placeholder="Senha" autocomplete="off" />
    <button id="btnEntrar">Entrar</button>
  </section>

  <section id="adminView" style="display:none; flex-direction: column;">
    <h2>📊 Painel Administrativo</h2>

    <div>
      <label for="filtroStatus">Filtrar por status:</label>
      <select id="filtroStatus">
        <option value="Todos">Todos</option>
        <option value="Pendente">Pendente</option>
        <option value="Em tratativa">Em tratativa</option>
        <option value="Resolvido">Resolvido</option>
      </select>

      <label for="filtroPlataforma">Plataforma:</label>
      <select id="filtroPlataforma">
        <option value="Todas">Todas</option>
        <option>Botmaker</option>
        <option>Olos</option>
        <option>Eaglle</option>
        <option>Lyceum</option>
        <option>Internet</option>
      </select>

      <label for="buscaNome">Buscar por nome:</label>
      <input type="text" id="buscaNome" placeholder="Digite um nome" />
    </div>

    <table id="tabelaChamados" aria-label="Tabela de chamados">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Cargo</th>
          <th>Plataforma</th>
          <th>Motivo</th>
          <th>Obs</th>
          <th>Data</th>
          <th>Hora</th>
          <th>Status</th>
          <th>Ação</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button id="btnExportar">📄 Exportar para Excel</button>
  </section>

<script>
(() => {
  const senhaCorreta = "admin123";
  const GOOGLE_SHEET_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyaUlvGoiPbYjrfoPHarYnEV4fcx2gzeE-v3cbESxowFXo1V93gBBnp_RUr_Y7M8Zqg/exec";

  // Elementos
  const formView = document.getElementById('formView');
  const adminView = document.getElementById('adminView');
  const senhaAdmin = document.getElementById('senhaAdmin');

  const btnEnviar = document.getElementById('btnEnviar');
  const btnEntrar = document.getElementById('btnEntrar');
  const btnExportar = document.getElementById('btnExportar');

  const filtroStatus = document.getElementById('filtroStatus');
  const filtroPlataforma = document.getElementById('filtroPlataforma');
  const buscaNome = document.getElementById('buscaNome');

  const notificacao = document.getElementById('notificacao');

  const tabelaBody = document.querySelector("#tabelaChamados tbody");

  // Mostra só a view informada
  function toggleView(viewId) {
    formView.style.display = 'none';
    adminView.style.display = 'none';
    senhaAdmin.style.display = 'none';

    if (viewId === 'formView') formView.style.display = 'flex';
    else if (viewId === 'adminView') adminView.style.display = 'flex';
    else if (viewId === 'senhaAdmin') senhaAdmin.style.display = 'flex';
  }

  function mostrarCampoSenha() {
    toggleView('senhaAdmin');
  }

  // Validação senha admin
  function validarSenha() {
    const senha = document.getElementById("senha").value;
    if (senha === senhaCorreta) {
      toggleView('adminView');
      carregarChamados();
      limparNotificacao();
    } else {
      alert("Senha incorreta.");
    }
  }

  // Envia formulário para o Google Sheets via fetch POST
  async function enviarFormulario() {
    limparNotificacao();

    const nome = document.getElementById("nome").value.trim();
    const cargo = document.getElementById("cargo").value;
    const plataforma = document.getElementById("plataforma").value;
    const motivo = document.getElementById("motivo").value;
    const obs = document.getElementById("obs").value.trim();

    if (!nome) {
      alert("Por favor, preencha o nome.");
      return;
    }

    const dataAtual = new Date();
    const data = dataAtual.toLocaleDateString('pt-BR');
    const hora = dataAtual.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

    const registro = {
      nome, cargo, plataforma, motivo, obs, data, hora, status: "Pendente"
    };

    try {
      const res = await fetch(GOOGLE_SHEET_WEBAPP_URL, {
        method: "POST",
        body: JSON.stringify(registro),
        headers: { "Content-Type": "application/json" }
      });

      if (!res.ok) throw new Error("Erro ao enviar os dados.");

      // Limpar campos
      document.getElementById("nome").value = "";
      document.getElementById("cargo").selectedIndex = 0;
      document.getElementById("plataforma").selectedIndex = 0;
      document.getElementById("motivo").selectedIndex = 0;
      document.getElementById("obs").value = "";

      mostrarNotificacao("✅ Chamado registrado com sucesso!", false);

    } catch (error) {
      alert(error.message || "Erro na conexão com o Google Sheets.");
    }
  }

  // Buscar e exibir chamados no admin
  async function carregarChamados() {
    limparNotificacao();

    try {
      const res = await fetch(GOOGLE_SHEET_WEBAPP_URL);
      if (!res.ok) throw new Error("Erro ao carregar chamados.");
      let chamados = await res.json();

      // Ordenar por data + hora desc
      chamados.sort((a,b) => {
        const dtA = new Date(a.data.split('/').reverse().join('-') + 'T' + a.hora + ':00');
        const dtB = new Date(b.data.split('/').reverse().join('-') + 'T' + b.hora + ':00');
        return dtB - dtA;
      });

      // Filtrar
      const statusFiltro = filtroStatus.value;
      const plataformaFiltro = filtroPlataforma.value;
      const nomeBusca = buscaNome.value.trim().toLowerCase();

      const filtrados = chamados.filter(item => {
        let condStatus = (statusFiltro === 'Todos') || (item.status === statusFiltro);
        let condPlataforma = (plataformaFiltro === 'Todas') || (item.plataforma === plataformaFiltro);
        let condNome = !nomeBusca || item.nome.toLowerCase().includes(nomeBusca);
        return condStatus && condPlataforma && condNome;
      });

      popularTabela(filtrados);
      mostrarNotificacao(`🔄 ${filtrados.length} chamados carregados.`);
    } catch (error) {
      alert(error.message || "Erro na conexão com o Google Sheets.");
    }
  }

  // Preenche tabela admin
  function popularTabela(chamados) {
    tabelaBody.innerHTML = "";

    if (chamados.length === 0) {
      tabelaBody.innerHTML = `<tr><td colspan="9" style="text-align:center; font-weight:600; padding: 30px;">Nenhum chamado encontrado</td></tr>`;
      return;
    }

    chamados.forEach(item => {
      const tr = document.createElement("tr");
      tr.className = item.status.toLowerCase().replace(/\s/g, '');

      tr.innerHTML = `
        <td>${escapeHtml(item.nome)}</td>
        <td>${escapeHtml(item.cargo)}</td>
        <td>${escapeHtml(item.plataforma)}</td>
        <td>${escapeHtml(item.motivo)}</td>
        <td>${escapeHtml(item.obs)}</td>
        <td>${escapeHtml(item.data)}</td>
        <td>${escapeHtml(item.hora)}</td>
        <td>${escapeHtml(item.status)}</td>
        <td>
          <button class="btn-table" onclick="atualizarStatus('${item.nome}', '${item.data}', '${item.hora}', 'Pendente')">Pendente</button>
          <button class="btn-table" onclick="atualizarStatus('${item.nome}', '${item.data}', '${item.hora}', 'Em tratativa')">Em tratativa</button>
          <button class="btn-table" onclick="atualizarStatus('${item.nome}', '${item.data}', '${item.hora}', 'Resolvido')">Resolvido</button>
        </td>
      `;
      tabelaBody.appendChild(tr);
    });
  }

  // Atualiza status do chamado (chave = nome+data+hora)
  async function atualizarStatus(nome, data, hora, novoStatus) {
    // Confirma alteração
    if (!confirm(`Confirma alterar status para "${novoStatus}"?`)) return;

    try {
      // Enviar patch para o Google Apps Script para alterar o status
      // Para isso, o seu Apps Script precisa suportar método PATCH/PUT e atualizar status por chave.
      // Aqui simulamos o envio via POST com operação de atualização.

      const payload = { nome, data, hora, status: novoStatus, acao: "atualizarStatus" };

      const res = await fetch(GOOGLE_SHEET_WEBAPP_URL, {
        method: "POST",
        body: JSON.stringify(payload),
        headers: { "Content-Type": "application/json" }
      });

      if (!res.ok) throw new Error("Erro ao atualizar status.");

      mostrarNotificacao(`✅ Status atualizado para "${novoStatus}".`, false);
      carregarChamados();

    } catch (error) {
      alert(error.message || "Erro na atualização de status.");
    }
  }

  // Exportar dados exibidos para Excel
  function exportarExcel() {
    const table = document.getElementById('tabelaChamados');
    const wb = XLSX.utils.table_to_book(table, { sheet: "Chamados" });
    XLSX.writeFile(wb, "Chamados_DiarioDeBordo.xlsx");
  }

  // Notificação na interface
  function mostrarNotificacao(msg, erro = true) {
    notificacao.style.opacity = 1;
    notificacao.textContent = msg;
    notificacao.style.color = erro ? "#a42b2b" : "#2a4da0";

    setTimeout(() => {
      notificacao.style.opacity = 0;
    }, 4000);
  }
  function limparNotificacao() {
    notificacao.textContent = "";
    notificacao.style.opacity = 0;
  }

  // Função para escapar HTML e evitar injeção na tabela
  function escapeHtml(text) {
    if (!text) return "";
    return text.replace(/[&<>"']/g, (m) => {
      switch (m) {
        case "&": return "&amp;";
        case "<": return "&lt;";
        case ">": return "&gt;";
        case '"': return "&quot;";
        case "'": return "&#39;";
        default: return m;
      }
    });
  }

  // Eventos
  btnEnviar.addEventListener("click", enviarFormulario);
  btnEntrar.addEventListener("click", validarSenha);
  btnExportar.addEventListener("click", exportarExcel);

  filtroStatus.addEventListener("change", carregarChamados);
  filtroPlataforma.addEventListener("change", carregarChamados);
  buscaNome.addEventListener("input", carregarChamados);

  // Inicialização
  toggleView('formView');
})();
</script>

</body>
</html>
